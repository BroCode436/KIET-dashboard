<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KIET Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .category-card {
            transition: all 0.3s ease;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.02));
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        .category-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
            border-color: rgba(59, 130, 246, 0.3);
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(59, 130, 246, 0.02));
        }
        .post-item {
            animation: slideIn 0.3s ease-out;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.04));
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .modal {
            backdrop-filter: blur(15px);
        }
        .like-btn {
            transition: all 0.2s ease;
        }
        .like-btn.liked {
            color: #ef4444;
            transform: scale(1.1);
        }
        .professional-border {
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .professional-border:focus {
            border-color: rgba(59, 130, 246, 0.5);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .stat-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        .professional-button {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            border: none;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
            transition: all 0.3s ease;
        }
        .professional-button:hover {
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
            transform: translateY(-1px);
        }
        .professional-button-secondary {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            border: none;
            box-shadow: 0 4px 15px rgba(107, 114, 128, 0.2);
            transition: all 0.3s ease;
        }
        .professional-button-secondary:hover {
            box-shadow: 0 6px 20px rgba(107, 114, 128, 0.3);
            transform: translateY(-1px);
        }
        .media-preview {
            max-height: 400px;
            overflow-x: auto;
            overflow-y: hidden;
        }
        .media-item {
            min-width: 200px;
            max-width: 300px;
            height: 200px;
            object-fit: cover;
        }
        .story-ring {
            background: linear-gradient(45deg, #3b82f6, #1d4ed8);
            padding: 3px;
            border-radius: 50%;
        }
        .story-inner {
            background: #1e293b;
            border-radius: 50%;
            padding: 2px;
        }
        .story-progress {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            height: 3px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            overflow: hidden;
        }
        .story-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #1d4ed8);
            border-radius: 2px;
            transition: width 0.1s linear;
        }
        .tag-suggestion {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(15px);
        }
        .tagged-user {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(59, 130, 246, 0.1));
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: #3b82f6;
        }
        .kiet-logo {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
            position: relative;
            overflow: hidden;
        }
        .kiet-logo::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="45" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="2"/><path d="M25 35 L50 20 L75 35 L75 65 L50 80 L25 65 Z" fill="rgba(255,255,255,0.1)"/><text x="50" y="58" text-anchor="middle" fill="white" font-family="Arial, sans-serif" font-size="24" font-weight="bold">K</text></svg>') center/contain no-repeat;
        }
        .header-logo {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
            position: relative;
            overflow: hidden;
        }
        .header-logo::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="none" stroke="rgba(255,255,255,0.15)" stroke-width="3"/><path d="M30 40 L50 25 L70 40 L70 60 L50 75 L30 60 Z" fill="rgba(255,255,255,0.1)"/><text x="50" y="58" text-anchor="middle" fill="white" font-family="Arial, sans-serif" font-size="20" font-weight="bold">K</text></svg>') center/contain no-repeat;
        }
        .badge-gold { background: linear-gradient(135deg, #fbbf24, #f59e0b); }
        .badge-silver { background: linear-gradient(135deg, #e5e7eb, #d1d5db); }
        .badge-bronze { background: linear-gradient(135deg, #d97706, #b45309); }
        .badge-blue { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .badge-green { background: linear-gradient(135deg, #10b981, #059669); }
        .badge-purple { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
        .badge-pink { background: linear-gradient(135deg, #ec4899, #db2777); }
        .badge-indigo { background: linear-gradient(135deg, #6366f1, #4f46e5); }
        .badge-red { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .badge-orange { background: linear-gradient(135deg, #f97316, #ea580c); }
        .badge-cyan { background: linear-gradient(135deg, #06b6d4, #0891b2); }
        .badge-gray { background: linear-gradient(135deg, #6b7280, #4b5563); }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 min-h-screen text-gray-100">
    
    <!-- Login/Register Page -->
    <div id="authPage" class="min-h-screen flex items-center justify-center p-4">
        <div class="glass-effect rounded-2xl shadow-2xl max-w-md w-full border border-white/20">
            <div class="p-8">
                <div class="text-center mb-8">
                    <div class="kiet-logo mx-auto mb-6"></div>
                    <h1 class="text-3xl font-bold text-white mb-2">KIET Dashboard</h1>
                    <p class="text-gray-300 text-sm">KIET Group of Institutions, Ghaziabad</p>
                    <p class="text-gray-400 text-xs mt-1">Student & Faculty Portal</p>
                </div>

                <!-- Login Form -->
                <div id="loginForm">
                    <h2 class="text-xl font-semibold mb-6 text-center text-white">Sign In</h2>
                    <form onsubmit="handleLogin(event)">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-300 mb-2">Email ID</label>
                            <input type="email" id="loginEmail" required class="w-full px-4 py-3 bg-white/5 professional-border rounded-lg text-gray-100 placeholder-gray-400 focus:outline-none" placeholder="your.email@kiet.ac.in">
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-300 mb-2">Password</label>
                            <input type="password" id="loginPassword" required class="w-full px-4 py-3 bg-white/5 professional-border rounded-lg text-gray-100 placeholder-gray-400 focus:outline-none" placeholder="Enter your password">
                        </div>
                        <div class="mb-6">
                            <label class="flex items-center">
                                <input type="checkbox" id="rememberMe" class="rounded border-gray-400 text-blue-500 bg-white/10 focus:ring-blue-500 focus:ring-2">
                                <span class="ml-2 text-sm text-gray-300">Remember me</span>
                            </label>
                        </div>
                        <button type="submit" class="w-full professional-button text-white font-medium py-3 px-6 rounded-lg">Sign In</button>
                    </form>
                    <p class="text-center mt-4 text-sm text-gray-400">
                        Don't have an account? 
                        <button onclick="showRegisterForm()" class="text-blue-400 hover:text-blue-300 font-medium">Register here</button>
                    </p>
                    <div class="mt-6 p-4 bg-white/5 rounded-lg text-xs text-gray-300 border border-white/10">
                        <strong class="text-blue-400">Demo Accounts:</strong><br>
                        Super Admin: admin@kiet.ac.in / admin123<br>
                        Teacher: sarah.johnson@kiet.ac.in / teacher123<br>
                        Student: student@kiet.ac.in / student123
                    </div>
                </div>

                <!-- Register Form -->
                <div id="registerForm" style="display: none;">
                    <h2 class="text-xl font-semibold mb-6 text-center text-white">Create Account</h2>
                    <form onsubmit="handleRegister(event)">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-300 mb-2">Full Name</label>
                            <input type="text" id="registerName" required class="w-full px-4 py-3 bg-white/5 professional-border rounded-lg text-gray-100 placeholder-gray-400 focus:outline-none" placeholder="Your full name">
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-300 mb-2">Email ID</label>
                            <input type="email" id="registerEmail" required class="w-full px-4 py-3 bg-white/5 professional-border rounded-lg text-gray-100 placeholder-gray-400 focus:outline-none" placeholder="your.email@kiet.ac.in">
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-300 mb-2">Set Password</label>
                            <input type="password" id="registerPassword" required class="w-full px-4 py-3 bg-white/5 professional-border rounded-lg text-gray-100 placeholder-gray-400 focus:outline-none" placeholder="Create a strong password">
                        </div>
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-300 mb-2">Confirm Password</label>
                            <input type="password" id="confirmPassword" required class="w-full px-4 py-3 bg-white/5 professional-border rounded-lg text-gray-100 placeholder-gray-400 focus:outline-none" placeholder="Confirm your password">
                        </div>
                        <button type="submit" class="w-full professional-button text-white font-medium py-3 px-6 rounded-lg">Create Account</button>
                    </form>
                    <p class="text-center mt-4 text-sm text-gray-400">
                        Already have an account? 
                        <button onclick="showLoginForm()" class="text-blue-400 hover:text-blue-300 font-medium">Sign in here</button>
                    </p>
                </div>

                <!-- OTP Verification -->
                <div id="otpForm" style="display: none;">
                    <h2 class="text-xl font-semibold mb-6 text-center text-white">Verify Email</h2>
                    <p class="text-sm text-gray-300 mb-6 text-center">We've sent a 6-digit code to your email address</p>
                    <div class="mb-6 p-4 bg-blue-500/10 rounded-lg text-center border border-blue-500/20">
                        <p class="text-sm text-blue-300">Demo OTP Code: <strong id="demoOtp" class="text-blue-400">123456</strong></p>
                    </div>
                    <form onsubmit="handleOtpVerification(event)">
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-300 mb-2">Enter OTP</label>
                            <input type="text" id="otpInput" required maxlength="6" class="w-full px-4 py-3 bg-white/5 professional-border rounded-lg text-center text-2xl tracking-widest text-blue-400 placeholder-gray-500 focus:outline-none" placeholder="000000">
                        </div>
                        <button type="submit" class="w-full professional-button text-white font-medium py-3 px-6 rounded-lg">Verify & Continue</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" style="display: none;">
        <!-- Header -->
        <header class="glass-effect shadow-xl border-b border-white/10">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center space-x-4">
                        <div class="header-logo cursor-pointer" onclick="showDashboard()"></div>
                        <div>
                            <h1 class="text-2xl font-bold text-white">KIET Dashboard</h1>
                            <p class="text-sm text-gray-300" id="currentPageTitle">Dashboard</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button onclick="showProfile(currentUser.id)" class="flex items-center space-x-2 text-sm text-gray-300 hover:text-blue-400 transition-colors" id="profileButton">
                            <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center text-white text-sm font-bold" id="headerAvatar">
                                U
                            </div>
                            <span id="userInfo" class="hidden sm:block"></span>
                        </button>
                        <button onclick="logout()" class="bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white px-4 py-2 rounded-lg font-medium transition-all shadow-lg">
                            Logout
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Dashboard -->
        <div id="dashboard" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Stats Overview -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="stat-card rounded-xl shadow-lg p-6 border-l-4 border-blue-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-300">Total Posts</p>
                            <p class="text-2xl font-bold text-blue-400" id="totalPosts">0</p>
                        </div>
                        <div class="text-blue-400 text-2xl">📊</div>
                    </div>
                </div>
                <div class="stat-card rounded-xl shadow-lg p-6 border-l-4 border-green-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-300">This Week</p>
                            <p class="text-2xl font-bold text-green-400" id="weeklyPosts">0</p>
                        </div>
                        <div class="text-green-400 text-2xl">📈</div>
                    </div>
                </div>
                <div class="stat-card rounded-xl shadow-lg p-6 border-l-4 border-purple-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-300">Categories</p>
                            <p class="text-2xl font-bold text-purple-400">7</p>
                        </div>
                        <div class="text-purple-400 text-2xl">🏷️</div>
                    </div>
                </div>
                <div class="stat-card rounded-xl shadow-lg p-6 border-l-4 border-orange-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-300">My Role</p>
                            <p class="text-lg font-bold text-orange-400" id="userRole">Student</p>
                        </div>
                        <div class="text-orange-400 text-2xl">👤</div>
                    </div>
                </div>
            </div>

            <!-- Stories Section -->
            <div class="glass-effect rounded-xl shadow-lg p-6 mb-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-white">📸 Stories</h2>
                    <button id="addStoryBtn" onclick="showAddStory()" style="display: none;" class="professional-button text-white font-medium py-2 px-4 rounded-lg text-sm">
                        ➕ Add Story
                    </button>
                </div>
                <div class="flex space-x-4 overflow-x-auto pb-2" id="storiesContainer">
                    <!-- Stories will be populated here -->
                </div>
            </div>

            <!-- Categories Grid -->
            <div class="glass-effect rounded-xl shadow-lg p-6 mb-8">
                <h2 class="text-xl font-bold text-white mb-6">📚 Browse Categories</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4" id="categoriesGrid">
                    <!-- Categories will be populated by JavaScript -->
                </div>
            </div>

            <!-- Admin Panel -->
            <div id="adminPanel" style="display: none;">
                <div class="glass-effect rounded-xl shadow-lg p-6 mb-8">
                    <h2 class="text-xl font-bold text-white mb-6">🛡️ Admin Actions</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <button onclick="showUserManagement()" class="professional-button text-white font-medium py-3 px-6 rounded-lg">
                            👥 Manage Users
                        </button>
                        <button onclick="showCreatePost()" class="professional-button text-white font-medium py-3 px-6 rounded-lg">
                            ✏️ Create Post
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Category View -->
        <div id="categoryView" style="display: none;" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="mb-6">
                <button onclick="showDashboard()" class="text-blue-400 hover:text-blue-300 font-medium">← Back to Dashboard</button>
            </div>
            
            <div class="glass-effect rounded-xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <div class="flex items-center space-x-3">
                        <span id="categoryIcon" class="text-3xl">📚</span>
                        <h2 id="categoryTitle" class="text-2xl font-bold text-white">Category Posts</h2>
                    </div>
                    <button id="createCategoryPost" onclick="showCreatePost()" style="display: none;" class="professional-button text-white font-medium py-2 px-4 rounded-lg">
                        ✏️ Create Post
                    </button>
                </div>
                <div id="categoryPosts" class="space-y-4">
                    <!-- Posts will be populated here -->
                </div>
            </div>
        </div>

        <!-- User Management -->
        <div id="userManagement" style="display: none;" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="mb-6">
                <button onclick="showDashboard()" class="text-blue-400 hover:text-blue-300 font-medium">← Back to Dashboard</button>
            </div>
            
            <div class="glass-effect rounded-xl shadow-lg p-6">
                <h2 class="text-2xl font-bold text-white mb-6">👥 User Management</h2>
                <div id="usersList" class="space-y-4">
                    <!-- Users will be populated here -->
                </div>
            </div>
        </div>

        <!-- Profile View -->
        <div id="profileView" style="display: none;" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="mb-6">
                <button onclick="goBackFromProfile()" class="text-blue-400 hover:text-blue-300 font-medium">← Back</button>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Profile Info -->
                <div class="lg:col-span-1">
                    <div class="glass-effect rounded-xl shadow-lg p-6 mb-6">
                        <div class="text-center mb-6">
                            <div class="w-24 h-24 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center mx-auto mb-4 text-white text-3xl font-bold shadow-lg" id="profileAvatar">
                                <!-- Avatar will be populated -->
                            </div>
                            <h2 class="text-2xl font-bold text-white" id="profileName">User Name</h2>
                            <p class="text-gray-300" id="profileEmail">user@email.com</p>
                            <div class="flex justify-center mt-4" id="profileRoleBadge">
                                <!-- Role badge will be populated -->
                            </div>
                        </div>
                        
                        <div class="space-y-3 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-400">Department:</span>
                                <span class="text-gray-200" id="profileDepartment">-</span>
                            </div>
                            <div class="flex justify-between" id="profileYearRow">
                                <span class="text-gray-400">Year:</span>
                                <span class="text-gray-200" id="profileYear">-</span>
                            </div>
                            <div class="flex justify-between" id="profileRollRow">
                                <span class="text-gray-400">Roll Number:</span>
                                <span class="text-gray-200" id="profileRollNumber">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Phone:</span>
                                <span class="text-gray-200" id="profilePhone">-</span>
                            </div>
                        </div>
                        
                        <div class="mt-6 pt-6 border-t border-gray-600">
                            <p class="text-gray-300 text-sm" id="profileBio">No bio available</p>
                        </div>
                        
                        <div class="mt-6 flex space-x-2" id="profileActions">
                            <!-- Action buttons will be populated -->
                        </div>
                    </div>
                    
                    <!-- Badges Section -->
                    <div class="glass-effect rounded-xl shadow-lg p-6">
                        <h3 class="text-lg font-bold text-white mb-4">🏆 Badges</h3>
                        <div class="grid grid-cols-2 gap-3" id="profileBadges">
                            <!-- Badges will be populated -->
                        </div>
                    </div>
                </div>
                
                <!-- Profile Content -->
                <div class="lg:col-span-2">
                    <div class="glass-effect rounded-xl shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-white">📝 Recent Posts</h3>
                        </div>
                        <div id="profilePosts" class="space-y-4">
                            <!-- User posts will be populated -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Post Modal -->
    <div id="createPostModal" class="fixed inset-0 bg-black bg-opacity-70 modal hidden items-center justify-center z-50 p-4">
        <div class="glass-effect rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto border border-white/20">
            <div class="p-6 border-b border-white/10">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-white">Create New Post</h3>
                    <button onclick="closeCreatePostModal()" class="text-gray-400 hover:text-white text-2xl transition-colors">&times;</button>
                </div>
            </div>
            
            <form id="createPostForm" class="p-6 space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Category</label>
                    <select id="postCategory" required class="w-full px-4 py-3 bg-white/5 professional-border rounded-lg text-gray-100 focus:outline-none">
                        <!-- Options will be populated by JavaScript -->
                    </select>
                </div>
                
                <div>
                    <label for="postTitle" class="block text-sm font-medium text-gray-300 mb-2">Title *</label>
                    <input type="text" id="postTitle" required class="w-full px-4 py-3 bg-white/5 professional-border rounded-lg text-gray-100 placeholder-gray-400 focus:outline-none" placeholder="Enter post title...">
                </div>
                
                <div>
                    <label for="postContent" class="block text-sm font-medium text-gray-300 mb-2">Content *</label>
                    <textarea id="postContent" required rows="6" class="w-full px-4 py-3 bg-white/5 professional-border rounded-lg text-gray-100 placeholder-gray-400 focus:outline-none" placeholder="Write your post content here..."></textarea>
                </div>

                <!-- Media Upload -->
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Media (Images/Videos)</label>
                    <input type="file" id="postMedia" multiple accept="image/*,video/*" class="w-full px-4 py-3 bg-white/5 professional-border rounded-lg text-gray-100 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-blue-600 file:text-white file:cursor-pointer focus:outline-none">
                    <div id="mediaPreview" class="mt-3 flex space-x-3 overflow-x-auto media-preview" style="display: none;">
                        <!-- Media previews will appear here -->
                    </div>
                </div>

                <!-- User Tagging -->
                <div class="relative">
                    <label for="postUserTags" class="block text-sm font-medium text-gray-300 mb-2">Tag People</label>
                    <input type="text" id="postUserTags" class="w-full px-4 py-3 bg-white/5 professional-border rounded-lg text-gray-100 placeholder-gray-400 focus:outline-none" placeholder="Type @ to tag people...">
                    <div id="tagSuggestions" class="absolute z-10 w-full mt-1 tag-suggestion rounded-lg shadow-lg hidden max-h-40 overflow-y-auto">
                        <!-- Tag suggestions will appear here -->
                    </div>
                    <div id="taggedUsers" class="mt-2 flex flex-wrap gap-2">
                        <!-- Tagged users will appear here -->
                    </div>
                </div>
                
                <div>
                    <label for="postTags" class="block text-sm font-medium text-gray-300 mb-2">Tags (optional)</label>
                    <input type="text" id="postTags" class="w-full px-4 py-3 bg-white/5 professional-border rounded-lg text-gray-100 placeholder-gray-400 focus:outline-none" placeholder="e.g., important, deadline, registration">
                </div>
                
                <div class="flex space-x-4 pt-4">
                    <button type="button" onclick="closeCreatePostModal()" class="flex-1 px-6 py-3 professional-button-secondary text-white rounded-lg font-medium">Cancel</button>
                    <button type="submit" class="flex-1 px-6 py-3 professional-button text-white rounded-lg font-medium">Publish Post</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Story Modal -->
    <div id="addStoryModal" class="fixed inset-0 bg-black bg-opacity-70 modal hidden items-center justify-center z-50 p-4">
        <div class="glass-effect rounded-xl shadow-2xl max-w-md w-full border border-white/20">
            <div class="p-6 border-b border-white/10">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-white">Add Story</h3>
                    <button onclick="closeAddStoryModal()" class="text-gray-400 hover:text-white text-2xl transition-colors">&times;</button>
                </div>
            </div>
            
            <form id="addStoryForm" class="p-6 space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Category</label>
                    <select id="storyCategory" required class="w-full px-4 py-3 bg-white/5 professional-border rounded-lg text-gray-100 focus:outline-none">
                        <!-- Options will be populated by JavaScript -->
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Story Media *</label>
                    <input type="file" id="storyMedia" required accept="image/*,video/*" class="w-full px-4 py-3 bg-white/5 professional-border rounded-lg text-gray-100 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-blue-600 file:text-white file:cursor-pointer focus:outline-none">
                    <div id="storyPreview" class="mt-3" style="display: none;">
                        <!-- Story preview will appear here -->
                    </div>
                </div>

                <div>
                    <label for="storyText" class="block text-sm font-medium text-gray-300 mb-2">Caption (optional)</label>
                    <textarea id="storyText" rows="3" class="w-full px-4 py-3 bg-white/5 professional-border rounded-lg text-gray-100 placeholder-gray-400 focus:outline-none" placeholder="Add a caption to your story..."></textarea>
                </div>
                
                <div class="flex space-x-4 pt-4">
                    <button type="button" onclick="closeAddStoryModal()" class="flex-1 px-6 py-3 professional-button-secondary text-white rounded-lg font-medium">Cancel</button>
                    <button type="submit" class="flex-1 px-6 py-3 professional-button text-white rounded-lg font-medium">Share Story</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Story Viewer Modal -->
    <div id="storyViewerModal" class="fixed inset-0 bg-black bg-opacity-90 hidden items-center justify-center z-50">
        <div class="relative w-full max-w-md h-full max-h-screen flex items-center justify-center">
            <div class="relative bg-black rounded-xl overflow-hidden shadow-2xl w-full max-w-sm" style="aspect-ratio: 9/16;">
                <div class="story-progress">
                    <div class="story-progress-bar" id="storyProgressBar" style="width: 0%;"></div>
                </div>
                
                <button onclick="closeStoryViewer()" class="absolute top-4 right-4 text-white text-2xl z-10 hover:text-blue-400 transition-colors">&times;</button>
                
                <div id="storyContent" class="w-full h-full flex items-center justify-center">
                    <!-- Story content will be loaded here -->
                </div>
                
                <div class="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black/80 to-transparent">
                    <div class="flex items-center space-x-3 mb-2">
                        <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center">
                            <span class="text-white text-sm font-bold" id="storyAuthorInitial">A</span>
                        </div>
                        <div>
                            <p class="text-white font-medium text-sm" id="storyAuthor">Author</p>
                            <p class="text-gray-300 text-xs" id="storyTime">2h ago</p>
                        </div>
                    </div>
                    <p class="text-white text-sm" id="storyCaption"></p>
                </div>
                
                <!-- Navigation -->
                <button onclick="previousStory()" class="absolute left-2 top-1/2 transform -translate-y-1/2 text-white text-2xl hover:text-blue-400 transition-colors">‹</button>
                <button onclick="nextStory()" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-white text-2xl hover:text-blue-400 transition-colors">›</button>
            </div>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div id="editProfileModal" class="fixed inset-0 bg-black bg-opacity-70 modal hidden items-center justify-center z-50 p-4">
        <div class="glass-effect rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto border border-white/20">
            <div class="p-6 border-b border-white/10">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-white">Edit Profile</h3>
                    <button onclick="closeEditProfileModal()" class="text-gray-400 hover:text-white text-2xl transition-colors">&times;</button>
                </div>
            </div>
            
            <form id="editProfileForm" class="p-6 space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="editName" class="block text-sm font-medium text-gray-300 mb-2">Full Name *</label>
                        <input type="text" id="editName" required class="w-full px-4 py-3 bg-white/5 professional-border rounded-lg text-gray-100 placeholder-gray-400 focus:outline-none" placeholder="Enter your full name">
                    </div>
                    
                    <div>
                        <label for="editPhone" class="block text-sm font-medium text-gray-300 mb-2">Phone Number</label>
                        <input type="tel" id="editPhone" class="w-full px-4 py-3 bg-white/5 professional-border rounded-lg text-gray-100 placeholder-gray-400 focus:outline-none" placeholder="+91-9876543210">
                    </div>
                </div>

                <div>
                    <label for="editBio" class="block text-sm font-medium text-gray-300 mb-2">Bio</label>
                    <textarea id="editBio" rows="3" class="w-full px-4 py-3 bg-white/5 professional-border rounded-lg text-gray-100 placeholder-gray-400 focus:outline-none" placeholder="Tell us about yourself..."></textarea>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="editDepartment" class="block text-sm font-medium text-gray-300 mb-2">Department</label>
                        <select id="editDepartment" class="w-full px-4 py-3 bg-white/5 professional-border rounded-lg text-gray-100 focus:outline-none">
                            <option value="">Select Department</option>
                            <option value="Computer Science & Engineering">Computer Science & Engineering</option>
                            <option value="Electronics & Communication">Electronics & Communication</option>
                            <option value="Mechanical Engineering">Mechanical Engineering</option>
                            <option value="Civil Engineering">Civil Engineering</option>
                            <option value="Electrical Engineering">Electrical Engineering</option>
                            <option value="Information Technology">Information Technology</option>
                            <option value="Management Studies">Management Studies</option>
                            <option value="Applied Sciences">Applied Sciences</option>
                            <option value="Administration">Administration</option>
                        </select>
                    </div>

                    <div id="editYearField">
                        <label for="editYear" class="block text-sm font-medium text-gray-300 mb-2">Year</label>
                        <select id="editYear" class="w-full px-4 py-3 bg-white/5 professional-border rounded-lg text-gray-100 focus:outline-none">
                            <option value="">Select Year</option>
                            <option value="1st Year">1st Year</option>
                            <option value="2nd Year">2nd Year</option>
                            <option value="3rd Year">3rd Year</option>
                            <option value="4th Year">4th Year</option>
                        </select>
                    </div>
                </div>

                <div id="editRollField">
                    <label for="editRollNumber" class="block text-sm font-medium text-gray-300 mb-2">Roll Number</label>
                    <input type="text" id="editRollNumber" class="w-full px-4 py-3 bg-white/5 professional-border rounded-lg text-gray-100 placeholder-gray-400 focus:outline-none" placeholder="e.g., 2022CS001">
                </div>
                
                <div class="flex space-x-4 pt-4">
                    <button type="button" onclick="closeEditProfileModal()" class="flex-1 px-6 py-3 professional-button-secondary text-white rounded-lg font-medium">Cancel</button>
                    <button type="submit" class="flex-1 px-6 py-3 professional-button text-white rounded-lg font-medium">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Manage Badges Modal -->
    <div id="manageBadgesModal" class="fixed inset-0 bg-black bg-opacity-70 modal hidden items-center justify-center z-50 p-4">
        <div class="glass-effect rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto border border-white/20">
            <div class="p-6 border-b border-white/10">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-white">Manage Badges</h3>
                    <button onclick="closeBadgesModal()" class="text-gray-400 hover:text-white text-2xl transition-colors">&times;</button>
                </div>
                <p class="text-gray-300 text-sm mt-2">Grant or revoke badges for <span id="badgeUserName" class="text-blue-400 font-medium"></span></p>
            </div>
            
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="badgesList">
                    <!-- Badges will be populated here -->
                </div>
                
                <div class="flex justify-end space-x-4 pt-6 mt-6 border-t border-gray-600">
                    <button onclick="closeBadgesModal()" class="px-6 py-3 professional-button-secondary text-white rounded-lg font-medium">Close</button>
                    <button onclick="saveBadgeChanges()" class="px-6 py-3 professional-button text-white rounded-lg font-medium">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let currentView = 'dashboard';
        let currentCategory = null;
        let posts = [];
        let users = [];
        let pendingRegistration = null;
        let stories = [];
        let currentStoryIndex = 0;
        let currentCategoryStories = [];
        let storyTimer = null;
        let taggedUsers = [];

        const categoryConfig = {
            academics: { icon: '📚', name: 'Academics', color: 'blue' },
            sports: { icon: '⚽', name: 'Sports', color: 'green' },
            cultural: { icon: '🎭', name: 'Cultural', color: 'purple' },
            placements: { icon: '💼', name: 'Placements', color: 'orange' },
            internships: { icon: '🎯', name: 'Internships', color: 'pink' },
            events: { icon: '🎉', name: 'Events', color: 'indigo' },
            announcements: { icon: '📢', name: 'Announcements', color: 'red' }
        };

        const badgeConfig = {
            // Role badges (automatic)
            student: { icon: '🎓', name: 'Student', color: 'blue', description: 'Enrolled student' },
            teacher: { icon: '👨‍🏫', name: 'Teacher', color: 'green', description: 'Faculty member' },
            super_admin: { icon: '👑', name: 'Super Admin', color: 'gold', description: 'System administrator' },
            category_admin: { icon: '🛡️', name: 'Category Admin', color: 'purple', description: 'Category administrator' },
            
            // Academic badges
            topper: { icon: '🏆', name: 'Topper', color: 'gold', description: 'Academic excellence' },
            scholar: { icon: '📖', name: 'Scholar', color: 'blue', description: 'Outstanding academic performance' },
            phd: { icon: '🎓', name: 'PhD', color: 'purple', description: 'Doctorate degree holder' },
            research_head: { icon: '🔬', name: 'Research Head', color: 'indigo', description: 'Research department head' },
            
            // Club and society badges
            tech_club: { icon: '💻', name: 'Tech Club', color: 'cyan', description: 'Technology club member' },
            cultural_club: { icon: '🎭', name: 'Cultural Club', color: 'pink', description: 'Cultural club member' },
            sports_club: { icon: '⚽', name: 'Sports Club', color: 'green', description: 'Sports club member' },
            debate_club: { icon: '🗣️', name: 'Debate Club', color: 'orange', description: 'Debate society member' },
            music_club: { icon: '🎵', name: 'Music Club', color: 'purple', description: 'Music club member' },
            drama_club: { icon: '🎪', name: 'Drama Club', color: 'red', description: 'Drama club member' },
            
            // Leadership badges
            president: { icon: '👑', name: 'President', color: 'gold', description: 'Club/Society president' },
            vice_president: { icon: '🥈', name: 'Vice President', color: 'silver', description: 'Club/Society vice president' },
            secretary: { icon: '📝', name: 'Secretary', color: 'blue', description: 'Club/Society secretary' },
            treasurer: { icon: '💰', name: 'Treasurer', color: 'green', description: 'Club/Society treasurer' },
            
            // Achievement badges
            winner: { icon: '🥇', name: 'Winner', color: 'gold', description: 'Competition winner' },
            runner_up: { icon: '🥈', name: 'Runner Up', color: 'silver', description: 'Competition runner up' },
            participant: { icon: '🏅', name: 'Participant', color: 'bronze', description: 'Event participant' },
            volunteer: { icon: '🤝', name: 'Volunteer', color: 'green', description: 'Community volunteer' },
            
            // Special badges
            founder: { icon: '⭐', name: 'Founder', color: 'gold', description: 'Platform founder' },
            mentor: { icon: '🧑‍🏫', name: 'Mentor', color: 'blue', description: 'Student mentor' },
            alumni: { icon: '🎓', name: 'Alumni', color: 'purple', description: 'KIET alumni' },
            guest: { icon: '👤', name: 'Guest', color: 'gray', description: 'Guest user' }
        };

        // Initialize demo users
        function initializeDemoUsers() {
            users = [
                {
                    id: 1,
                    name: 'Super Admin',
                    email: 'admin@kiet.ac.in',
                    password: 'admin123',
                    role: 'super_admin',
                    categories: Object.keys(categoryConfig),
                    verified: true,
                    profile: {
                        bio: 'System Administrator managing KIET Dashboard',
                        department: 'Administration',
                        year: null,
                        rollNumber: null,
                        phone: '+91-9876543210',
                        avatar: null,
                        badges: ['super_admin', 'founder']
                    }
                },
                {
                    id: 2,
                    name: 'Demo Student',
                    email: 'student@kiet.ac.in',
                    password: 'student123',
                    role: 'student',
                    categories: [],
                    verified: true,
                    profile: {
                        bio: 'Computer Science student passionate about technology',
                        department: 'Computer Science & Engineering',
                        year: '3rd Year',
                        rollNumber: '2022CS001',
                        phone: '+91-9876543211',
                        avatar: null,
                        badges: ['student', 'tech_club']
                    }
                },
                {
                    id: 3,
                    name: 'Dr. Sarah Johnson',
                    email: 'sarah.johnson@kiet.ac.in',
                    password: 'teacher123',
                    role: 'teacher',
                    categories: ['academics'],
                    verified: true,
                    profile: {
                        bio: 'Associate Professor in Computer Science Department',
                        department: 'Computer Science & Engineering',
                        year: null,
                        rollNumber: null,
                        phone: '+91-9876543212',
                        avatar: null,
                        badges: ['teacher', 'phd', 'research_head']
                    }
                }
            ];
        }

        // Authentication functions
        function showLoginForm() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('otpForm').style.display = 'none';
        }

        function showRegisterForm() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
            document.getElementById('otpForm').style.display = 'none';
        }

        function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const remember = document.getElementById('rememberMe').checked;

            const user = users.find(u => u.email === email && u.password === password && u.verified);
            
            if (user) {
                currentUser = user;
                if (remember) {
                    localStorage.setItem('rememberedUser', JSON.stringify(user));
                }
                showMainApp();
            } else {
                alert('Invalid credentials or account not verified');
            }
        }

        function handleRegister(event) {
            event.preventDefault();
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (password !== confirmPassword) {
                alert('Passwords do not match');
                return;
            }

            if (users.find(u => u.email === email)) {
                alert('Email already registered');
                return;
            }

            pendingRegistration = {
                name,
                email,
                password,
                role: 'student',
                categories: [],
                verified: false
            };

            // Generate demo OTP
            const otp = Math.floor(100000 + Math.random() * 900000).toString();
            document.getElementById('demoOtp').textContent = otp;
            pendingRegistration.otp = otp;

            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('otpForm').style.display = 'block';
        }

        function handleOtpVerification(event) {
            event.preventDefault();
            const enteredOtp = document.getElementById('otpInput').value;

            if (enteredOtp === pendingRegistration.otp) {
                pendingRegistration.id = users.length + 1;
                pendingRegistration.verified = true;
                delete pendingRegistration.otp;
                users.push(pendingRegistration);
                
                currentUser = pendingRegistration;
                pendingRegistration = null;
                showMainApp();
            } else {
                alert('Invalid OTP. Please try again.');
            }
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('rememberedUser');
            document.getElementById('authPage').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
            showLoginForm();
        }

        function showMainApp() {
            document.getElementById('authPage').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            updateUserInfo();
            showDashboard();
            initializeSamplePosts();
        }

        function updateUserInfo() {
            const roleDisplay = getRoleDisplayName(currentUser);
            document.getElementById('userInfo').textContent = `${currentUser.name} (${roleDisplay})`;
            document.getElementById('userRole').textContent = roleDisplay;
            document.getElementById('headerAvatar').textContent = currentUser.name.charAt(0).toUpperCase();
            
            if (currentUser.role === 'super_admin') {
                document.getElementById('adminPanel').style.display = 'block';
            } else {
                document.getElementById('adminPanel').style.display = 'none';
            }

            // Show add story button for category admins and super admins
            if (currentUser.role === 'super_admin' || currentUser.role === 'category_admin' || currentUser.role === 'teacher') {
                document.getElementById('addStoryBtn').style.display = 'block';
            } else {
                document.getElementById('addStoryBtn').style.display = 'none';
            }
        }

        function getRoleDisplayName(user) {
            if (user.role === 'student') {
                return 'STUDENT';
            } else if (user.role === 'super_admin') {
                return 'SUPER ADMIN';
            } else if (user.role === 'category_admin') {
                if (user.categories && user.categories.length > 0) {
                    if (user.categories.length === 1) {
                        return `${categoryConfig[user.categories[0]].name.toUpperCase()} ADMIN`;
                    } else {
                        return `${user.categories.map(cat => categoryConfig[cat].name).join(', ').toUpperCase()} ADMIN`;
                    }
                } else {
                    return 'EDIT';
                }
            } else if (user.role === 'teacher') {
                return 'TEACHER';
            }
            return 'USER';
        }

        function showDashboard() {
            currentView = 'dashboard';
            document.getElementById('dashboard').style.display = 'block';
            document.getElementById('categoryView').style.display = 'none';
            document.getElementById('userManagement').style.display = 'none';
            document.getElementById('profileView').style.display = 'none';
            document.getElementById('currentPageTitle').textContent = 'Dashboard';
            
            updateStats();
            renderCategoriesGrid();
            renderStories();
        }

        function showCategory(category) {
            currentView = 'category';
            currentCategory = category;
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('categoryView').style.display = 'block';
            document.getElementById('userManagement').style.display = 'none';
            
            const config = categoryConfig[category];
            document.getElementById('categoryIcon').textContent = config.icon;
            document.getElementById('categoryTitle').textContent = config.name;
            document.getElementById('currentPageTitle').textContent = config.name;
            
            // Show create post button for admins with access
            if (canCreateInCategory(category)) {
                document.getElementById('createCategoryPost').style.display = 'block';
            } else {
                document.getElementById('createCategoryPost').style.display = 'none';
            }
            
            renderCategoryPosts(category);
        }

        function showUserManagement() {
            if (currentUser.role !== 'super_admin') return;
            
            currentView = 'users';
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('categoryView').style.display = 'none';
            document.getElementById('userManagement').style.display = 'block';
            document.getElementById('profileView').style.display = 'none';
            document.getElementById('currentPageTitle').textContent = 'User Management';
            
            renderUsersList();
        }

        function showProfile(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;
            
            currentView = 'profile';
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('categoryView').style.display = 'none';
            document.getElementById('userManagement').style.display = 'none';
            document.getElementById('profileView').style.display = 'block';
            document.getElementById('currentPageTitle').textContent = `${user.name}'s Profile`;
            
            renderProfile(user);
        }

        function goBackFromProfile() {
            showDashboard();
        }

        function renderProfile(user) {
            // Basic info
            document.getElementById('profileAvatar').textContent = user.name.charAt(0).toUpperCase();
            document.getElementById('profileName').textContent = user.name;
            document.getElementById('profileEmail').textContent = user.email;
            
            // Role badge
            const roleBadge = badgeConfig[user.role];
            const badgeColorClass = `badge-${roleBadge.color}`;
            document.getElementById('profileRoleBadge').innerHTML = `
                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${badgeColorClass} text-white border border-white/20">
                    ${roleBadge.icon} ${roleBadge.name}
                </span>
            `;
            
            // Profile details
            const profile = user.profile || {};
            document.getElementById('profileDepartment').textContent = profile.department || '-';
            document.getElementById('profilePhone').textContent = profile.phone || '-';
            document.getElementById('profileBio').textContent = profile.bio || 'No bio available';
            
            // Show/hide student-specific fields
            if (user.role === 'student') {
                document.getElementById('profileYearRow').style.display = 'flex';
                document.getElementById('profileRollRow').style.display = 'flex';
                document.getElementById('profileYear').textContent = profile.year || '-';
                document.getElementById('profileRollNumber').textContent = profile.rollNumber || '-';
            } else {
                document.getElementById('profileYearRow').style.display = 'none';
                document.getElementById('profileRollRow').style.display = 'none';
            }
            
            // Action buttons
            const actionsContainer = document.getElementById('profileActions');
            actionsContainer.innerHTML = '';
            
            if (user.id === currentUser.id) {
                actionsContainer.innerHTML = `
                    <button onclick="showEditProfile()" class="flex-1 professional-button text-white px-4 py-2 rounded-lg text-sm font-medium">
                        ✏️ Edit Profile
                    </button>
                `;
            } else if (canManageBadges()) {
                actionsContainer.innerHTML = `
                    <button onclick="showManageBadges(${user.id})" class="flex-1 professional-button text-white px-4 py-2 rounded-lg text-sm font-medium">
                        🏆 Manage Badges
                    </button>
                `;
            }
            
            // Render badges
            renderProfileBadges(user);
            
            // Render user posts
            renderProfilePosts(user);
        }

        function renderProfileBadges(user) {
            const container = document.getElementById('profileBadges');
            const userBadges = user.profile?.badges || [];
            
            if (userBadges.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-sm col-span-2 text-center">No badges earned yet</p>';
                return;
            }
            
            container.innerHTML = userBadges.map(badgeKey => {
                const badge = badgeConfig[badgeKey];
                if (!badge) return '';
                
                const badgeColorClass = `badge-${badge.color}`;
                
                return `
                    <div class="${badgeColorClass} border border-white/20 rounded-lg p-3 text-center hover:shadow-lg transition-all text-white">
                        <div class="text-2xl mb-1">${badge.icon}</div>
                        <div class="text-xs font-medium">${badge.name}</div>
                    </div>
                `;
            }).join('');
        }

        function renderProfilePosts(user) {
            const container = document.getElementById('profilePosts');
            const userPosts = posts.filter(post => post.authorId === user.id);
            
            if (userPosts.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 text-gray-400">
                        <div class="text-4xl mb-4">📝</div>
                        <p>No posts yet.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = userPosts.slice(0, 5).map(post => renderPost(post)).join('');
        }

        function canManageBadges() {
            return currentUser.role === 'super_admin' || currentUser.role === 'category_admin';
        }

        function showCreatePost() {
            if (!canCreatePosts()) return;
            
            populatePostCategoryOptions();
            document.getElementById('createPostModal').classList.remove('hidden');
            document.getElementById('createPostModal').classList.add('flex');
            document.body.style.overflow = 'hidden';
        }

        function closeCreatePostModal() {
            document.getElementById('createPostModal').classList.add('hidden');
            document.getElementById('createPostModal').classList.remove('flex');
            document.body.style.overflow = 'auto';
            document.getElementById('createPostForm').reset();
        }

        function canCreatePosts() {
            return currentUser.role === 'super_admin' || currentUser.role === 'category_admin' || currentUser.role === 'teacher';
        }

        function canCreateInCategory(category) {
            return currentUser.role === 'super_admin' || 
                   (currentUser.role === 'category_admin' && currentUser.categories.includes(category)) ||
                   (currentUser.role === 'teacher' && currentUser.categories.includes(category));
        }

        function populatePostCategoryOptions() {
            const select = document.getElementById('postCategory');
            select.innerHTML = '';
            
            const availableCategories = currentUser.role === 'super_admin' 
                ? Object.keys(categoryConfig)
                : currentUser.categories;
            
            availableCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = categoryConfig[category].name;
                if (currentCategory === category) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        }

        function renderCategoriesGrid() {
            const grid = document.getElementById('categoriesGrid');
            grid.innerHTML = '';
            
            Object.entries(categoryConfig).forEach(([key, config]) => {
                const count = posts.filter(post => post.category === key).length;
                const card = document.createElement('button');
                card.onclick = () => showCategory(key);
                card.className = `category-card rounded-lg p-4 text-center transition-all`;
                card.innerHTML = `
                    <div class="text-2xl mb-2">${config.icon}</div>
                    <div class="text-sm font-medium text-gray-200">${config.name}</div>
                    <div class="text-xs text-blue-400 mt-1">${count} post${count !== 1 ? 's' : ''}</div>
                `;
                grid.appendChild(card);
            });
        }

        function renderCategoryPosts(category) {
            const container = document.getElementById('categoryPosts');
            const categoryPosts = posts.filter(post => post.category === category);
            
            if (categoryPosts.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 text-gray-400">
                        <div class="text-4xl mb-4">${categoryConfig[category].icon}</div>
                        <p>No posts in ${categoryConfig[category].name} yet.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = categoryPosts.map(post => renderPost(post)).join('');
        }

        function renderPost(post) {
            const config = categoryConfig[post.category];
            const timeAgo = getTimeAgo(post.timestamp);
            const isLiked = post.likes && post.likes.includes(currentUser.id);
            const likeCount = post.likes ? post.likes.length : 0;
            const commentCount = post.comments ? post.comments.length : 0;
            
            return `
                <div class="post-item rounded-lg p-6 hover:shadow-md transition-shadow">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center space-x-2">
                            <span class="text-lg">${config.icon}</span>
                            <span class="text-sm font-medium text-blue-400 bg-blue-500/20 px-2 py-1 rounded-full border border-blue-500/30">${config.name}</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-xs text-gray-400">${timeAgo}</span>
                            ${canDeletePost(post) ? `<button onclick="deletePost(${post.id})" class="text-red-400 hover:text-red-300 text-sm">🗑️</button>` : ''}
                        </div>
                    </div>
                    
                    <h4 class="font-semibold text-gray-100 mb-3 text-lg">${post.title}</h4>
                    <p class="text-gray-300 mb-4 leading-relaxed">${post.content}</p>
                    
                    ${post.media && post.media.length > 0 ? `
                        <div class="mb-4 flex space-x-3 overflow-x-auto media-preview">
                            ${post.media.map(media => `
                                <div class="flex-shrink-0">
                                    ${media.type.startsWith('image/') ? 
                                        `<img src="${media.url}" alt="Post media" class="media-item rounded-lg border border-white/20">` :
                                        `<video src="${media.url}" class="media-item rounded-lg border border-white/20" controls></video>`
                                    }
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}

                    ${post.taggedUsers && post.taggedUsers.length > 0 ? `
                        <div class="flex flex-wrap gap-2 mb-4">
                            ${post.taggedUsers.map(user => `<span class="tagged-user text-xs px-2 py-1 rounded-full">@${user.name}</span>`).join('')}
                        </div>
                    ` : ''}
                    
                    ${post.tags && post.tags.length > 0 ? `
                        <div class="flex flex-wrap gap-2 mb-4">
                            ${post.tags.map(tag => `<span class="text-xs bg-white/10 text-gray-300 px-2 py-1 rounded-full border border-white/20">#${tag}</span>`).join('')}
                        </div>
                    ` : ''}
                    
                    <div class="flex items-center justify-between pt-4 border-t border-gray-600">
                        <div class="flex items-center space-x-4">
                            <button onclick="toggleLike(${post.id})" class="like-btn flex items-center space-x-1 text-sm ${isLiked ? 'liked text-red-400' : 'text-gray-400 hover:text-red-400'}">
                                <span>${isLiked ? '❤️' : '🤍'}</span>
                                <span>${likeCount}</span>
                            </button>
                            <button onclick="toggleComments(${post.id})" class="flex items-center space-x-1 text-sm text-gray-400 hover:text-blue-400">
                                <span>💬</span>
                                <span>${commentCount}</span>
                            </button>
                        </div>
                        <div class="text-xs text-gray-400">
                            By ${post.author} • ${post.timestamp.toLocaleDateString()}
                        </div>
                    </div>
                    
                    <!-- Comments Section -->
                    <div id="comments-${post.id}" class="mt-4 pt-4 border-t border-gray-600" style="display: none;">
                        <div class="space-y-3 mb-4">
                            ${post.comments ? post.comments.map(comment => `
                                <div class="bg-white/5 rounded-lg p-3 border border-white/10">
                                    <div class="flex justify-between items-start mb-1">
                                        <span class="font-medium text-sm text-gray-200">${comment.author}</span>
                                        <span class="text-xs text-gray-400">${getTimeAgo(comment.timestamp)}</span>
                                    </div>
                                    <p class="text-sm text-gray-300">${comment.content}</p>
                                </div>
                            `).join('') : ''}
                        </div>
                        <div class="flex space-x-2">
                            <input type="text" id="comment-input-${post.id}" placeholder="Write a comment..." class="flex-1 px-3 py-2 bg-white/5 professional-border rounded-lg text-sm text-gray-100 placeholder-gray-400 focus:outline-none">
                            <button onclick="addComment(${post.id})" class="professional-button text-white px-4 py-2 rounded-lg text-sm font-medium">Post</button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Story Functions
        function renderStories() {
            const container = document.getElementById('storiesContainer');
            const categoryStories = {};
            
            // Group stories by category
            stories.forEach(story => {
                if (!categoryStories[story.category]) {
                    categoryStories[story.category] = [];
                }
                categoryStories[story.category].push(story);
            });

            container.innerHTML = '';
            
            // Render category story rings
            Object.entries(categoryConfig).forEach(([key, config]) => {
                const categoryStoriesArray = categoryStories[key] || [];
                const hasStories = categoryStoriesArray.length > 0;
                const hasUnseenStories = categoryStoriesArray.some(story => !story.seenBy.includes(currentUser.id));
                
                const storyRing = document.createElement('div');
                storyRing.className = 'flex-shrink-0 cursor-pointer';
                storyRing.onclick = () => hasStories ? openStoryViewer(key) : null;
                
                storyRing.innerHTML = `
                    <div class="text-center">
                        <div class="${hasStories ? (hasUnseenStories ? 'story-ring' : 'border-2 border-gray-600') : 'border-2 border-gray-700'} rounded-full p-1">
                            <div class="story-inner">
                                <div class="w-16 h-16 bg-gradient-to-br from-gray-700 to-gray-800 rounded-full flex items-center justify-center text-2xl ${hasStories ? '' : 'opacity-50'}">
                                    ${config.icon}
                                </div>
                            </div>
                        </div>
                        <p class="text-xs text-gray-300 mt-2 max-w-[70px] truncate">${config.name}</p>
                        ${hasStories ? `<p class="text-xs text-blue-400">${categoryStoriesArray.length}</p>` : ''}
                    </div>
                `;
                
                container.appendChild(storyRing);
            });
        }

        function showAddStory() {
            if (!canCreatePosts()) return;
            
            populateStoryCategoryOptions();
            document.getElementById('addStoryModal').classList.remove('hidden');
            document.getElementById('addStoryModal').classList.add('flex');
            document.body.style.overflow = 'hidden';
        }

        function closeAddStoryModal() {
            document.getElementById('addStoryModal').classList.add('hidden');
            document.getElementById('addStoryModal').classList.remove('flex');
            document.body.style.overflow = 'auto';
            document.getElementById('addStoryForm').reset();
            document.getElementById('storyPreview').style.display = 'none';
        }

        function populateStoryCategoryOptions() {
            const select = document.getElementById('storyCategory');
            select.innerHTML = '';
            
            const availableCategories = currentUser.role === 'super_admin' 
                ? Object.keys(categoryConfig)
                : currentUser.categories;
            
            availableCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = categoryConfig[category].name;
                select.appendChild(option);
            });
        }

        function openStoryViewer(category) {
            const categoryStories = stories.filter(story => story.category === category);
            if (categoryStories.length === 0) return;
            
            currentCategoryStories = categoryStories;
            currentStoryIndex = 0;
            
            document.getElementById('storyViewerModal').classList.remove('hidden');
            document.getElementById('storyViewerModal').classList.add('flex');
            document.body.style.overflow = 'hidden';
            
            showCurrentStory();
        }

        function closeStoryViewer() {
            document.getElementById('storyViewerModal').classList.add('hidden');
            document.getElementById('storyViewerModal').classList.remove('flex');
            document.body.style.overflow = 'auto';
            
            if (storyTimer) {
                clearInterval(storyTimer);
                storyTimer = null;
            }
        }

        function showCurrentStory() {
            if (currentStoryIndex >= currentCategoryStories.length) {
                closeStoryViewer();
                return;
            }
            
            const story = currentCategoryStories[currentStoryIndex];
            const storyContent = document.getElementById('storyContent');
            const progressBar = document.getElementById('storyProgressBar');
            
            // Mark story as seen
            if (!story.seenBy.includes(currentUser.id)) {
                story.seenBy.push(currentUser.id);
            }
            
            // Display story content
            if (story.media.type.startsWith('image/')) {
                storyContent.innerHTML = `<img src="${story.media.url}" alt="Story" class="w-full h-full object-cover">`;
            } else {
                storyContent.innerHTML = `<video src="${story.media.url}" class="w-full h-full object-cover" autoplay muted></video>`;
            }
            
            // Update story info
            document.getElementById('storyAuthor').textContent = story.author;
            document.getElementById('storyAuthorInitial').textContent = story.author.charAt(0).toUpperCase();
            document.getElementById('storyTime').textContent = getTimeAgo(story.timestamp);
            document.getElementById('storyCaption').textContent = story.caption || '';
            
            // Start progress animation
            progressBar.style.width = '0%';
            let progress = 0;
            const duration = 5000; // 5 seconds
            const interval = 50;
            const increment = (interval / duration) * 100;
            
            if (storyTimer) clearInterval(storyTimer);
            
            storyTimer = setInterval(() => {
                progress += increment;
                progressBar.style.width = progress + '%';
                
                if (progress >= 100) {
                    clearInterval(storyTimer);
                    nextStory();
                }
            }, interval);
        }

        function nextStory() {
            currentStoryIndex++;
            showCurrentStory();
        }

        function previousStory() {
            if (currentStoryIndex > 0) {
                currentStoryIndex--;
                showCurrentStory();
            }
        }

        // Media handling functions
        function handleMediaUpload(files, previewContainer) {
            const mediaArray = [];
            previewContainer.innerHTML = '';
            previewContainer.style.display = files.length > 0 ? 'flex' : 'none';
            
            Array.from(files).forEach((file, index) => {
                const mediaUrl = URL.createObjectURL(file);
                const mediaItem = {
                    url: mediaUrl,
                    type: file.type,
                    name: file.name
                };
                mediaArray.push(mediaItem);
                
                const mediaElement = document.createElement('div');
                mediaElement.className = 'relative flex-shrink-0';
                
                if (file.type.startsWith('image/')) {
                    mediaElement.innerHTML = `
                        <img src="${mediaUrl}" alt="Preview" class="media-item rounded-lg border border-white/20">
                        <button onclick="removeMedia(${index}, '${previewContainer.id}')" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-red-600">×</button>
                    `;
                } else if (file.type.startsWith('video/')) {
                    mediaElement.innerHTML = `
                        <video src="${mediaUrl}" class="media-item rounded-lg border border-white/20" controls></video>
                        <button onclick="removeMedia(${index}, '${previewContainer.id}')" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-red-600">×</button>
                    `;
                }
                
                previewContainer.appendChild(mediaElement);
            });
            
            return mediaArray;
        }

        function removeMedia(index, containerId) {
            const container = document.getElementById(containerId);
            const mediaElements = container.children;
            if (mediaElements[index]) {
                mediaElements[index].remove();
            }
            if (container.children.length === 0) {
                container.style.display = 'none';
            }
        }

        // User tagging functions
        function handleUserTagging(input) {
            const value = input.value;
            const atIndex = value.lastIndexOf('@');
            
            if (atIndex !== -1 && atIndex === value.length - 1) {
                showTagSuggestions();
            } else if (atIndex !== -1) {
                const searchTerm = value.substring(atIndex + 1).toLowerCase();
                filterTagSuggestions(searchTerm);
            } else {
                hideTagSuggestions();
            }
        }

        function showTagSuggestions() {
            const suggestions = document.getElementById('tagSuggestions');
            suggestions.innerHTML = users.filter(user => user.id !== currentUser.id)
                .map(user => `
                    <div onclick="selectUser(${user.id}, '${user.name}')" class="p-2 hover:bg-white/10 cursor-pointer text-gray-300 border-b border-gray-700 last:border-b-0">
                        <div class="flex items-center space-x-2">
                            <div class="w-6 h-6 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center text-xs text-white">
                                ${user.name.charAt(0).toUpperCase()}
                            </div>
                            <span>${user.name}</span>
                        </div>
                    </div>
                `).join('');
            suggestions.classList.remove('hidden');
        }

        function filterTagSuggestions(searchTerm) {
            const suggestions = document.getElementById('tagSuggestions');
            const filteredUsers = users.filter(user => 
                user.id !== currentUser.id && 
                user.name.toLowerCase().includes(searchTerm) &&
                !taggedUsers.some(tagged => tagged.id === user.id)
            );
            
            if (filteredUsers.length > 0) {
                suggestions.innerHTML = filteredUsers.map(user => `
                    <div onclick="selectUser(${user.id}, '${user.name}')" class="p-2 hover:bg-white/10 cursor-pointer text-gray-300 border-b border-gray-700 last:border-b-0">
                        <div class="flex items-center space-x-2">
                            <div class="w-6 h-6 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center text-xs text-white">
                                ${user.name.charAt(0).toUpperCase()}
                            </div>
                            <span>${user.name}</span>
                        </div>
                    </div>
                `).join('');
                suggestions.classList.remove('hidden');
            } else {
                hideTagSuggestions();
            }
        }

        function hideTagSuggestions() {
            document.getElementById('tagSuggestions').classList.add('hidden');
        }

        function selectUser(userId, userName) {
            const user = users.find(u => u.id === userId);
            if (user && !taggedUsers.some(tagged => tagged.id === userId)) {
                taggedUsers.push(user);
                updateTaggedUsersDisplay();
                
                // Clear the input
                const input = document.getElementById('postUserTags');
                const value = input.value;
                const atIndex = value.lastIndexOf('@');
                input.value = value.substring(0, atIndex);
            }
            hideTagSuggestions();
        }

        function updateTaggedUsersDisplay() {
            const container = document.getElementById('taggedUsers');
            container.innerHTML = taggedUsers.map(user => `
                <span class="tagged-user text-xs px-2 py-1 rounded-full flex items-center space-x-1">
                    <span>@${user.name}</span>
                    <button onclick="removeTaggedUser(${user.id})" class="text-blue-300 hover:text-white">×</button>
                </span>
            `).join('');
        }

        function removeTaggedUser(userId) {
            taggedUsers = taggedUsers.filter(user => user.id !== userId);
            updateTaggedUsersDisplay();
        }

        function canDeletePost(post) {
            return currentUser.role === 'super_admin' || 
                   (currentUser.role === 'category_admin' && currentUser.categories.includes(post.category)) ||
                   post.authorId === currentUser.id;
        }

        function toggleLike(postId) {
            const post = posts.find(p => p.id === postId);
            if (!post.likes) post.likes = [];
            
            const userIndex = post.likes.indexOf(currentUser.id);
            if (userIndex > -1) {
                post.likes.splice(userIndex, 1);
            } else {
                post.likes.push(currentUser.id);
            }
            
            if (currentView === 'category') {
                renderCategoryPosts(currentCategory);
            }
        }

        function toggleComments(postId) {
            const commentsDiv = document.getElementById(`comments-${postId}`);
            commentsDiv.style.display = commentsDiv.style.display === 'none' ? 'block' : 'none';
        }

        function addComment(postId) {
            const input = document.getElementById(`comment-input-${postId}`);
            const content = input.value.trim();
            
            if (!content) return;
            
            const post = posts.find(p => p.id === postId);
            if (!post.comments) post.comments = [];
            
            post.comments.push({
                id: Date.now(),
                author: currentUser.name,
                authorId: currentUser.id,
                content: content,
                timestamp: new Date()
            });
            
            input.value = '';
            
            if (currentView === 'category') {
                renderCategoryPosts(currentCategory);
            }
        }

        function renderUsersList() {
            const container = document.getElementById('usersList');
            container.innerHTML = users.map(user => `
                <div class="post-item rounded-lg p-4">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center space-x-3 mb-2">
                                <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center text-white font-bold cursor-pointer" onclick="showProfile(${user.id})">
                                    ${user.name.charAt(0).toUpperCase()}
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-100 cursor-pointer hover:text-blue-400" onclick="showProfile(${user.id})">${user.name}</h4>
                                    <p class="text-sm text-gray-300">${user.email}</p>
                                </div>
                            </div>
                            <p class="text-sm text-blue-400">Role: ${getRoleDisplayName(user)}</p>
                            ${user.role === 'category_admin' ? `<p class="text-xs text-gray-400">Categories: ${user.categories.map(cat => categoryConfig[cat].name).join(', ')}</p>` : ''}
                            ${user.profile?.badges ? `
                                <div class="flex flex-wrap gap-1 mt-2">
                                    ${user.profile.badges.slice(0, 3).map(badgeKey => {
                                        const badge = badgeConfig[badgeKey];
                                        if (!badge) return '';
                                        const badgeColorClass = `badge-${badge.color}`;
                                        return `<span class="text-xs ${badgeColorClass} text-white px-2 py-1 rounded-full border border-white/20">${badge.icon} ${badge.name}</span>`;
                                    }).join('')}
                                    ${user.profile.badges.length > 3 ? `<span class="text-xs text-gray-400">+${user.profile.badges.length - 3} more</span>` : ''}
                                </div>
                            ` : ''}
                        </div>
                        ${user.id !== currentUser.id ? `
                            <div class="space-x-2 flex flex-col gap-2">
                                <select onchange="updateUserRole(${user.id}, this.value)" class="text-sm bg-white/5 professional-border rounded px-2 py-1 text-gray-100 focus:outline-none">
                                    <option value="student" ${user.role === 'student' ? 'selected' : ''}>Student</option>
                                    <option value="teacher" ${user.role === 'teacher' ? 'selected' : ''}>Teacher</option>
                                    <option value="category_admin" ${user.role === 'category_admin' ? 'selected' : ''}>Category Admin</option>
                                    <option value="super_admin" ${user.role === 'super_admin' ? 'selected' : ''}>Super Admin</option>
                                </select>
                                <div class="flex gap-1">
                                    ${user.role === 'category_admin' ? `<button onclick="manageCategoryAccess(${user.id})" class="text-xs professional-button text-white px-2 py-1 rounded">Categories</button>` : ''}
                                    <button onclick="showManageBadges(${user.id})" class="text-xs professional-button text-white px-2 py-1 rounded">Badges</button>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        function showEditProfile() {
            const user = currentUser;
            const profile = user.profile || {};
            
            // Populate form
            document.getElementById('editName').value = user.name;
            document.getElementById('editPhone').value = profile.phone || '';
            document.getElementById('editBio').value = profile.bio || '';
            document.getElementById('editDepartment').value = profile.department || '';
            document.getElementById('editYear').value = profile.year || '';
            document.getElementById('editRollNumber').value = profile.rollNumber || '';
            
            // Show/hide fields based on role
            if (user.role === 'student') {
                document.getElementById('editYearField').style.display = 'block';
                document.getElementById('editRollField').style.display = 'block';
            } else {
                document.getElementById('editYearField').style.display = 'none';
                document.getElementById('editRollField').style.display = 'none';
            }
            
            document.getElementById('editProfileModal').classList.remove('hidden');
            document.getElementById('editProfileModal').classList.add('flex');
            document.body.style.overflow = 'hidden';
        }

        function closeEditProfileModal() {
            document.getElementById('editProfileModal').classList.add('hidden');
            document.getElementById('editProfileModal').classList.remove('flex');
            document.body.style.overflow = 'auto';
        }

        let currentBadgeUser = null;
        let badgeChanges = {};

        function showManageBadges(userId) {
            const user = users.find(u => u.id === userId);
            if (!user || !canManageBadges()) return;
            
            currentBadgeUser = user;
            badgeChanges = {};
            
            document.getElementById('badgeUserName').textContent = user.name;
            renderBadgesList(user);
            
            document.getElementById('manageBadgesModal').classList.remove('hidden');
            document.getElementById('manageBadgesModal').classList.add('flex');
            document.body.style.overflow = 'hidden';
        }

        function closeBadgesModal() {
            document.getElementById('manageBadgesModal').classList.add('hidden');
            document.getElementById('manageBadgesModal').classList.remove('flex');
            document.body.style.overflow = 'auto';
            currentBadgeUser = null;
            badgeChanges = {};
        }

        function renderBadgesList(user) {
            const container = document.getElementById('badgesList');
            const userBadges = user.profile?.badges || [];
            
            // Filter out role badges that shouldn't be manually assigned
            const availableBadges = Object.entries(badgeConfig).filter(([key, badge]) => {
                // Don't show role badges in manual assignment
                if (['student', 'teacher', 'super_admin', 'category_admin'].includes(key)) {
                    return false;
                }
                return true;
            });
            
            container.innerHTML = availableBadges.map(([badgeKey, badge]) => {
                const hasCurrently = userBadges.includes(badgeKey);
                const willHave = badgeChanges.hasOwnProperty(badgeKey) ? badgeChanges[badgeKey] : hasCurrently;
                const badgeColorClass = `badge-${badge.color}`;
                
                return `
                    <div class="bg-white/5 border border-white/20 rounded-lg p-4 hover:shadow-lg transition-all">
                        <div class="flex items-center justify-between mb-3">
                            <div class="text-2xl">${badge.icon}</div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" ${willHave ? 'checked' : ''} onchange="toggleBadge('${badgeKey}', this.checked)" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>
                        <div class="text-sm font-medium text-white mb-1">${badge.name}</div>
                        <div class="text-xs text-gray-400">${badge.description}</div>
                        ${hasCurrently !== willHave ? `
                            <div class="mt-2 text-xs ${willHave ? 'text-green-400' : 'text-red-400'}">
                                ${willHave ? '+ Will be granted' : '- Will be revoked'}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function toggleBadge(badgeKey, checked) {
            const user = currentBadgeUser;
            const userBadges = user.profile?.badges || [];
            const hasCurrently = userBadges.includes(badgeKey);
            
            if (hasCurrently === checked) {
                // No change from current state
                delete badgeChanges[badgeKey];
            } else {
                // Change from current state
                badgeChanges[badgeKey] = checked;
            }
            
            renderBadgesList(user);
        }

        function saveBadgeChanges() {
            if (!currentBadgeUser) return;
            
            const user = currentBadgeUser;
            if (!user.profile) user.profile = {};
            if (!user.profile.badges) user.profile.badges = [];
            
            // Apply changes
            Object.entries(badgeChanges).forEach(([badgeKey, shouldHave]) => {
                const currentIndex = user.profile.badges.indexOf(badgeKey);
                
                if (shouldHave && currentIndex === -1) {
                    // Grant badge
                    user.profile.badges.push(badgeKey);
                } else if (!shouldHave && currentIndex !== -1) {
                    // Revoke badge
                    user.profile.badges.splice(currentIndex, 1);
                }
            });
            
            // Update role badge automatically
            const roleBadgeIndex = user.profile.badges.indexOf(user.role);
            if (roleBadgeIndex === -1) {
                user.profile.badges.unshift(user.role);
            }
            
            closeBadgesModal();
            
            // Refresh current view
            if (currentView === 'users') {
                renderUsersList();
            } else if (currentView === 'profile') {
                renderProfile(user);
            }
        }

        function updateUserRole(userId, newRole) {
            const user = users.find(u => u.id === userId);
            user.role = newRole;
            if (newRole !== 'category_admin') {
                user.categories = newRole === 'super_admin' ? Object.keys(categoryConfig) : [];
            }
            renderUsersList();
        }

        function manageCategoryAccess(userId) {
            const user = users.find(u => u.id === userId);
            const categories = Object.keys(categoryConfig);
            const selected = user.categories || [];
            
            const checkboxes = categories.map(cat => 
                `<label class="flex items-center space-x-2 mb-2">
                    <input type="checkbox" value="${cat}" ${selected.includes(cat) ? 'checked' : ''}>
                    <span>${categoryConfig[cat].icon} ${categoryConfig[cat].name}</span>
                </label>`
            ).join('');
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4 modal';
            modal.innerHTML = `
                <div class="glass-effect rounded-xl shadow-2xl max-w-md w-full p-6 border border-white/20">
                    <h3 class="text-lg font-bold mb-4 text-white">Manage Category Access for ${user.name}</h3>
                    <div class="space-y-2 mb-6 text-gray-300">
                        ${checkboxes}
                    </div>
                    <div class="flex space-x-4">
                        <button onclick="this.closest('.fixed').remove()" class="flex-1 px-4 py-2 professional-button-secondary text-white rounded-lg">Cancel</button>
                        <button onclick="saveCategoryAccess(${userId}, this)" class="flex-1 px-4 py-2 professional-button text-white rounded-lg">Save</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function saveCategoryAccess(userId, button) {
            const modal = button.closest('.fixed');
            const checkboxes = modal.querySelectorAll('input[type="checkbox"]:checked');
            const selectedCategories = Array.from(checkboxes).map(cb => cb.value);
            
            const user = users.find(u => u.id === userId);
            user.categories = selectedCategories;
            
            modal.remove();
            renderUsersList();
        }

        function deletePost(postId) {
            if (confirm('Are you sure you want to delete this post?')) {
                posts = posts.filter(post => post.id !== postId);
                updateStats();
                if (currentView === 'category') {
                    renderCategoryPosts(currentCategory);
                } else if (currentView === 'dashboard') {
                    renderCategoriesGrid();
                }
            }
        }

        function updateStats() {
            document.getElementById('totalPosts').textContent = posts.length;
            
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            const weeklyCount = posts.filter(post => post.timestamp > oneWeekAgo).length;
            document.getElementById('weeklyPosts').textContent = weeklyCount;
        }

        function getTimeAgo(timestamp) {
            const now = new Date();
            const diff = now - timestamp;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 1) return 'Just now';
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            return `${days}d ago`;
        }

        function initializeSamplePosts() {
            if (posts.length > 0) return; // Don't reinitialize if posts already exist
            
            posts = [
                {
                    id: 1,
                    category: 'academics',
                    title: 'New Semester Registration Open',
                    content: 'Registration for the upcoming semester is now open. Students can register through the student portal until March 15th. Please ensure all previous semester dues are cleared before registration.',
                    tags: ['registration', 'deadline', 'important'],
                    timestamp: new Date(Date.now() - 2 * 60 * 60 * 1000), // 2 hours ago
                    author: 'Academic Office',
                    authorId: 1,
                    likes: [2],
                    comments: [
                        {
                            id: 1,
                            author: 'Demo Student',
                            authorId: 2,
                            content: 'When will the course catalog be available?',
                            timestamp: new Date(Date.now() - 1 * 60 * 60 * 1000)
                        }
                    ]
                },
                {
                    id: 2,
                    category: 'placements',
                    title: 'Microsoft Campus Drive',
                    content: 'Microsoft will be conducting campus interviews next week. Eligible students should register by tomorrow. Minimum CGPA requirement is 7.5.',
                    tags: ['microsoft', 'placement', 'interview'],
                    timestamp: new Date(Date.now() - 6 * 60 * 60 * 1000), // 6 hours ago
                    author: 'Placement Cell',
                    authorId: 1,
                    likes: [2],
                    comments: []
                },
                {
                    id: 3,
                    category: 'cultural',
                    title: 'Annual Cultural Fest - Confluence 2024',
                    content: 'Get ready for the biggest cultural event of the year! Registrations for various competitions are now open. Dance, music, drama, and art competitions await you.',
                    tags: ['cultural', 'fest', 'competition'],
                    timestamp: new Date(Date.now() - 12 * 60 * 60 * 1000), // 12 hours ago
                    author: 'Cultural Committee',
                    authorId: 1,
                    likes: [2],
                    comments: []
                }
            ];
        }

        // Form submission for creating posts
        document.getElementById('createPostForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const category = document.getElementById('postCategory').value;
            const title = document.getElementById('postTitle').value.trim();
            const content = document.getElementById('postContent').value.trim();
            const tags = document.getElementById('postTags').value.trim();
            const mediaFiles = document.getElementById('postMedia').files;
            
            if (title && content && canCreateInCategory(category)) {
                const mediaArray = mediaFiles.length > 0 ? 
                    handleMediaUpload(mediaFiles, document.getElementById('mediaPreview')) : [];
                
                const post = {
                    id: Date.now(),
                    category: category,
                    title: title,
                    content: content,
                    tags: tags ? tags.split(',').map(tag => tag.trim()) : [],
                    media: mediaArray,
                    taggedUsers: [...taggedUsers],
                    timestamp: new Date(),
                    author: currentUser.name,
                    authorId: currentUser.id,
                    likes: [],
                    comments: []
                };
                
                posts.unshift(post);
                updateStats();
                closeCreatePostModal();
                
                // Reset tagged users
                taggedUsers = [];
                
                if (currentView === 'category' && currentCategory === category) {
                    renderCategoryPosts(currentCategory);
                } else if (currentView === 'dashboard') {
                    renderCategoriesGrid();
                }
            }
        });

        // Form submission for creating stories
        document.getElementById('addStoryForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const category = document.getElementById('storyCategory').value;
            const caption = document.getElementById('storyText').value.trim();
            const mediaFile = document.getElementById('storyMedia').files[0];
            
            if (mediaFile && canCreateInCategory(category)) {
                const mediaUrl = URL.createObjectURL(mediaFile);
                
                const story = {
                    id: Date.now(),
                    category: category,
                    caption: caption,
                    media: {
                        url: mediaUrl,
                        type: mediaFile.type,
                        name: mediaFile.name
                    },
                    timestamp: new Date(),
                    author: currentUser.name,
                    authorId: currentUser.id,
                    seenBy: []
                };
                
                stories.unshift(story);
                closeAddStoryModal();
                renderStories();
            }
        });

        // Form submission for editing profile
        document.getElementById('editProfileForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const name = document.getElementById('editName').value.trim();
            const phone = document.getElementById('editPhone').value.trim();
            const bio = document.getElementById('editBio').value.trim();
            const department = document.getElementById('editDepartment').value;
            const year = document.getElementById('editYear').value;
            const rollNumber = document.getElementById('editRollNumber').value.trim();
            
            if (name) {
                // Update user info
                currentUser.name = name;
                
                // Update profile
                if (!currentUser.profile) currentUser.profile = {};
                currentUser.profile.phone = phone;
                currentUser.profile.bio = bio;
                currentUser.profile.department = department;
                
                if (currentUser.role === 'student') {
                    currentUser.profile.year = year;
                    currentUser.profile.rollNumber = rollNumber;
                }
                
                closeEditProfileModal();
                updateUserInfo();
                
                // Refresh profile view if currently viewing own profile
                if (currentView === 'profile') {
                    renderProfile(currentUser);
                }
            }
        });

        // Media upload preview handlers
        document.getElementById('postMedia').addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                handleMediaUpload(e.target.files, document.getElementById('mediaPreview'));
            }
        });

        document.getElementById('storyMedia').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const preview = document.getElementById('storyPreview');
            
            if (file) {
                const mediaUrl = URL.createObjectURL(file);
                preview.style.display = 'block';
                
                if (file.type.startsWith('image/')) {
                    preview.innerHTML = `<img src="${mediaUrl}" alt="Story preview" class="w-full max-w-xs rounded-lg border border-white/20">`;
                } else if (file.type.startsWith('video/')) {
                    preview.innerHTML = `<video src="${mediaUrl}" class="w-full max-w-xs rounded-lg border border-white/20" controls></video>`;
                }
            } else {
                preview.style.display = 'none';
            }
        });

        // User tagging input handler
        document.getElementById('postUserTags').addEventListener('input', function(e) {
            handleUserTagging(e.target);
        });

        // Hide tag suggestions when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('#postUserTags') && !e.target.closest('#tagSuggestions')) {
                hideTagSuggestions();
            }
        });

        // Close modal on outside click
        document.getElementById('createPostModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeCreatePostModal();
            }
        });

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            initializeDemoUsers();
            
            // Check for remembered user
            const rememberedUser = localStorage.getItem('rememberedUser');
            if (rememberedUser) {
                const user = JSON.parse(rememberedUser);
                const validUser = users.find(u => u.id === user.id && u.email === user.email);
                if (validUser) {
                    currentUser = validUser;
                    showMainApp();
                    return;
                }
            }
            
            // Show login page
            document.getElementById('authPage').style.display = 'flex';
            showLoginForm();
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9744ad55536e919e',t:'MTc1NjA1NzY3MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
